define(function(require,exports,module){var $=require("jquery");require("bootstrap"),require("treeview")($),require("form"),require("jquery-ui"),require("localStorage"),require("tpl");require("common");$("#form_one").click(function(){$("#form_check").hide()});var t=function(t){var e="";return e="string"==typeof t?t:t.href,!!(e=e.replace(/[^#]*#/g,""))&&($.get("assets/"+e,function(t){return $("#layout_right").html(t),!1}),!1)};exports.init=function(){$(function(){$(document).on("click",".loadhtml",function(){t(this)}),$.ajaxSetup({type:"POST",beforeSend:function(t,e){t.setRequestHeader("If-Modified-Since","0"),e.url.indexOf("html?")>0&&$.localStorage("ajax-param",e.url);var a=$.localStorage("token");if(a){if("GET"==e.type)return void(e.url.indexOf("?")>0?e.url+="&token="+a:e.url+="?token="+a);"undefined"==typeof e.data&&(e.data=new FormData),"object"==typeof e.data?e.data.append("token",a):e.data+="&token="+a}},complete:function(t){if("object"==typeof t.responseJSON){if(t.responseJSON.code==-1){var e=function(t,e){var a=e.next().find(".btn");return a.prop("disabled",!1),a.removeClass("disabled"),a.find("span").text("登录"),200!=t.code?void alert(t.message):($.localStorage("token",t.data.token),location.reload(),void e.dialog("close"))};return i({title:"请登录",content:$("#login_tpl").html(),url:exports.cgi("admin","login"),width:300,form_id:"login",but_cancel:{text:"取消",show:!1},but_submit:{text:"登录",show:!0},callback:e}),!1}200!=t.responseJSON.code&&exports.error(t.responseJSON.message),exports._formcallback(t.responseJSON)}}}),$("#siteListNavDom").on("click","li",function(){var t=$(this);"active"!=t.attr("class")&&$.ajax({url:exports.cgi("api/act","switchSite/"+t.attr("siteid")),dataType:"json",success:function(e){0==e.status&&($("#siteListNavDom").find("li").removeClass("active"),t.attr("class","active"),$("#treeview").find("li.active>a").trigger("click"))}})}),exports.height=$(window).height()-100,$(".mini-layout").css("height",exports.height),$(document).on("submit","form",function(t){var e=$(this),a=e.find('button[type="submit"]'),o=a.text();e.ajaxSubmit({dataType:"json",beforeSend:function(t,e){t.setRequestHeader("If-Modified-Since","0"),"undefined"==typeof e.data&&(e.data=new FormData),"object"==typeof e.data?e.data.append("token",$.localStorage("token")):e.data+="&token="+$.localStorage("token"),a.prop("disabled",!0),a.addClass("disabled"),a.text("提交中...")},success:function(t){a.prop("disabled",!1),a.removeClass("disabled"),a.text(o),exports._formcallback(t,e)},error:function(){a.prop("disabled",!1),a.removeClass("disabled"),a.text(o),exports._formcallback({code:1e4,message:"网络错误，请重试"})}}),t.preventDefault()})})};var e=function(t){var e=$('<div class="alert_float label label-success">'+t+"</div>").hide();$("body").append(e),e.fadeIn();var a=$(window).width(),o=a/2-e.width();e.css("left",o),setTimeout(function(){e.fadeOut(function(){e.remove()})},3e3)},a=function(t,e){var a={content:"",callback:null,title:"信息提示框",isShowOkBut:!1,okButName:"继续",url:null,id:"",width:0,height:0,pageDataFun:null};if(e="undefined"==typeof e?"":e,"hide"==t)return $("#__dialog_"+e).modal("hide"),!1;t=$.extend({},a,t),t.id="#__dialog_"+t.id;var o=$(t.id);if(t.content||$.ajax({async:!1,url:t.url,dataType:"html",success:function(e){t.content=e}}),!o.get(0)){var i=t.width>0?"width:"+t.width+"px;":"",n='<div class="modal" style="'+i+'" id="'+t.id.replace("#","")+'"><div class="modal-header"><a class="close" data-dismiss="modal">×</a><h3 class="__dialog_title">'+t.title+'</h3></div><div class="modal-body __dialog_content">'+t.content+'</div><div class="modal-footer"><a href="#" class="btn btn-primary __dialog_butok">继续</a>&nbsp;<a href="#" data-dismiss="modal">关闭</a></div></div>';$(n).appendTo("body")}$(".__dialog_title",t.id).html(t.title),$(".__dialog_content",t.id).html(t.content),$(".__dialog_butok",t.id).html(t.okButName).hide(),$(".__dialog_butok",t.id).unbind("click"),t.isShowOkBut?($(".__dialog_butok",t.id).show(),t.callback&&$(".__dialog_butok",t.id).click(function(){t.callback($(t.id))})):$(t.id).hide(),$(t.id).modal({backdrop:!1,keyboard:!1,show:!0}),$(t.id).show(),t.pageDataFun&&t.pageDataFun($(t.id))},o=function(t){var e={file_name:"imgFile",upload_url:"login"};t=$.extend({},e,t);var a=Math.floor(Math.random()*(1e8+1)),o='<div class="img_upload_form"><form method="post" id="'+a+'" enctype="multipart/form-data" action="'+t.upload_url+'"><input readonly="readonly" style="vertical-align: top; float:left;" type="text" id="upload_text"/><div style="float: left;width: 88px;overflow: hidden;position: relative"><button type="button" style="margin-left: 5px;" class="btn">选择图片</button><input type="file" style="position: absolute; top: 0;right:0;opacity: 0;filter: alpha(opacity=0);" name="'+t.file_name+'" id="'+t.file_name+'"/></div></form></div>',i=$(o).dialog({autoOpen:!1,width:330,modal:!0,title:"上传图片",resizable:!1,buttons:{"上传":function(){var e=$(this),o=e.parents(".ui-dialog").find(".ui-dialog-buttonset button").eq(0);$("#"+a).ajaxSubmit({dataType:"JSON",async:!1,beforeSend:function(){o.addClass("disabled").addClass("btn"),o.text("上传中...")},success:function(a){0===parseInt(a.error)?(window.alert("错误"),e.dialog("close")):t.success&&void 0!==t.success?t.success():alert("上传成功"+a.img_src)},error:function(){alert("网络错误,请重试"),o.removeClass("disabled").removeClass("btn"),o.text("上传")}})},"取消":function(){$(this).dialog("close")}},close:function(){$(this).remove()}});i.dialog("open"),$(document).on("change","#"+a+" #"+t.file_name,function(){var t=$(this).val();$("#"+a+" #upload_text").val(t)})},i=function(t){var a={content:"请确定！",title:"提示",url:"",width:300,form_id:"",but_cancel:{text:"取消",show:!0},but_submit:{text:"提交",show:!0},callback:exports._formcallback};t=$.extend({},a,t);var o=t.form_id?t.form_id:Math.floor(Math.random()*(1e8+1));if(!($("#form_dialog_"+o).length>0)){t.url&&void 0!==t.url?t.content='<div class="form_dialog"><form id="form_dialog_'+o+'" action="'+t.url+'" method="post">'+t.content+"</form></div>":t.content='<div class="form_dialog" id="form_dialog_'+o+'">'+t.content+"</div>";var i={};i[t.but_submit.text]=function(){var a=$(this),i=a.parents(".ui-dialog").find(".ui-dialog-buttonset button").eq(0);t.url&&void 0!==t.url?$("#form_dialog_"+o).ajaxSubmit({async:!1,dataType:"JSON",beforeSend:function(){i.addClass("disabled").addClass("btn"),i.find("span").text("提交中...")},success:function(o){t.callback&&void 0!==t.callback?t.callback(o,a):(e("提交成功！"),a.dialog("close"))},error:function(){alert("网络错误,请重试"),i.removeClass("disabled").removeClass("btn"),i.text("上传")}}):t.callback&&void 0!==t.callback?t.callback($(this)):$(this).close()},t.but_cancel.show&&(i[t.but_cancel.text]=function(){$(this).dialog("close")});var n=$(t.content).dialog({autoOpen:!1,width:t.width,modal:!0,title:t.title,resizable:!1,buttons:i,close:function(){$(this).remove()}});n.dialog("open"),$(".ui-dialog").zIndex(9999)}};exports.img_upload=o,exports.dialog=a,exports.alert=function(t){a({title:"提示信息",content:t,isShowOkBut:!1})},exports.confirm=function(t,e){a({title:"确认信息",content:t,isShowOkBut:!0,callback:"undefined"==typeof e?function(){a("hide")}:e})},exports.alert_float=e,exports.form_dialog=i,exports._formcallback=function(t){alert("需要在具体model中实现 common._formcallback 方法")},exports.cgi=function(t,e){var a=location.href.replace(/.*\.html/gi,"");return a+t+"/"+e},exports.error=function(t,e){e="undefined"==typeof e?"danger":e;var a="alert alert-"+e;$("#postmsg").html(t).attr("class",a).show(0,function(){setTimeout(function(){$("#postmsg").hide()},3e3)})},exports.i=function(t,e){e="undefined"!=typeof e&&e;var a=e?$.localStorage("ajax-param"):location.href,o=new RegExp(t+"=([^&]+)"),i=a.match(o);return i?i[1]:""},exports.loadhtml=t});